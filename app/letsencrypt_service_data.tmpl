{{ $CurrentContainer := where $ "ID" .Docker.CurrentContainerID | first }}

LETSENCRYPT_CONTAINERS=(
    {{ range $hosts, $containers := groupBy $ "Env.LETSENCRYPT_HOST" }}
        {{ if trim $hosts }}
            {{ range $container := $containers }}
                {{ range $knownNetwork := $CurrentContainer.Networks }}
                    {{ range $containerNetwork := $container.Networks }}
                        {{ if eq $knownNetwork.Name $containerNetwork.Name }}
                            '{{ printf "%.12s" $container.ID }}'
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
)

{{ range $hosts, $containers := groupBy $ "Env.LETSENCRYPT_HOST" }}
    {{ if trim $hosts }}
        {{ range $container := $containers }}
            {{ range $knownNetwork := $CurrentContainer.Networks }}
                {{ range $containerNetwork := $container.Networks }}
                    {{ if eq $knownNetwork.Name $containerNetwork.Name }}
                        {{ $cid := printf "%.12s" $container.ID }}
                        LETSENCRYPT_{{ $cid }}_HOST=( {{ range $host := split $hosts "," }}'{{ $host }}' {{ end }})
                        LETSENCRYPT_{{ $cid }}_EMAIL="{{ $container.Env.LETSENCRYPT_EMAIL }}"
                        LETSENCRYPT_{{ $cid }}_TEST="{{ $container.Env.LETSENCRYPT_TEST }}"
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}
